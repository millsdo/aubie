<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Aubie Tracker</title>
<style>
body {
  background:#081a2b;
  color:#3ef0b1;
  font-family: monospace;
  margin:0;
  padding:20px;
}
.card {
  border:1px solid #1f3a55;
  border-radius:12px;
  padding:16px;
  margin-bottom:20px;
}
</style>
</head>
<body>

<div class="card">
  <div id="awosTitle">KAUO AWOS</div>
  <div id="awosData">Loading weather data...</div>
</div>

<script>
const RENDER_BASE = "https://aubie.onrender.com";
const STATION = "KAUO";

function fmtTempC(v){
  if(v==null||!isFinite(Number(v))) return null;
  return Number(v).toFixed(1)+"°C";
}

// ✅ CORRECT conversion from hPa → inHg
function fmtAltimInHg(hpa){
  if(hpa==null||!isFinite(Number(hpa))) return null;
  const inHg = Number(hpa)*0.0295299830714;
  return inHg.toFixed(2)+" inHg";
}

function visDisplay(v){
  if(v==null) return null;
  if(typeof v==="number") return v+" mi";
  if(typeof v==="string"){
    if(v.includes("+")) return v.replace("+","+")+" mi";
    if(v.toUpperCase().includes("SM"))
      return v.toUpperCase().replace("SM"," mi");
    return v+" mi";
  }
  return null;
}

async function fetchAWOS(){
  try{
    const r = await fetch(`${RENDER_BASE}/metar?ids=${STATION}`,{cache:"no-store"});
    const arr = await r.json();
    if(!Array.isArray(arr)||!arr.length) throw new Error("No METAR");
    const m = arr[0];

    const wind = (m.wdir!=null && m.wspd!=null)
      ? `${m.wdir}° @ ${m.wspd} kt`
      : "N/A";

    const temp = fmtTempC(m.temp) ?? "N/A";
    const dew  = fmtTempC(m.dewp) ?? "N/A";
    const alt  = fmtAltimInHg(m.altim);
    const vis  = visDisplay(m.visib);
    const cat  = (m.fltCat||m.fltcat||"VFR").toString().toUpperCase();

    const parts=[];
    parts.push(`Wind: ${wind}`);
    parts.push(`Temp: ${temp}`);
    parts.push(`Dewpoint: ${dew}`);
    if(alt) parts.push(`Altimeter: ${alt}`);
    if(vis) parts.push(`Visibility: ${vis}`);
    parts.push(`Flight Cat: ${cat}`);

    document.getElementById("awosData").textContent = parts.join(" | ");
  }
  catch(e){
    console.error(e);
    document.getElementById("awosData").textContent =
      "Weather unavailable - "+e.message;
  }
}

fetchAWOS();
setInterval(fetchAWOS,60000);
</script>

</body>
</html>
