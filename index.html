<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AWOS / METAR Display</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#071018; color:#d7f7ff; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 28px 16px; }
    .card { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 18px 18px; }
    .title { letter-spacing: 0.3em; opacity: 0.75; font-size: 12px; margin: 0 0 10px; text-transform: uppercase; }
    .line { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: 22px; line-height: 1.5; color: #3ef0b1; }
    .meta { margin-top: 14px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: 12px; opacity: 0.7; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <p class="title" id="stationTitle">AWOS</p>
      <div class="line" id="awosLine">Loading…</div>
      <div class="meta" id="rawMetar"></div>
    </div>
  </div>

<script>
/**
 * CONFIG
 *  - RENDER_BASE: your Render proxy base URL (already live)
 *  - STATION: ICAO station ID
 */
const RENDER_BASE = "https://aubie.onrender.com";
const STATION = "KAUO"; // change to whatever you want

function calcFlightCategory(visibilitySm, ceilingFt) {
  const vis = (typeof visibilitySm === "number" && isFinite(visibilitySm)) ? visibilitySm : null;
  const ceil = (typeof ceilingFt === "number" && isFinite(ceilingFt)) ? ceilingFt : null;

  if (vis !== null && vis < 1) return "LIFR";
  if (ceil !== null && ceil < 500) return "LIFR";

  if (vis !== null && vis < 3) return "IFR";
  if (ceil !== null && ceil < 1000) return "IFR";

  if (vis !== null && vis < 5) return "MVFR";
  if (ceil !== null && ceil < 3000) return "MVFR";

  if (vis !== null || ceil !== null) return "VFR";
  return "VFR"; // default if missing
}

function extractCeilingFt(metarObj) {
  const skies = metarObj?.sky_condition;
  if (!Array.isArray(skies)) return null;

  let ceil = null;
  for (const layer of skies) {
    const cover = (layer?.sky_cover || "").toUpperCase();
    const base = Number(layer?.cloud_base_ft_agl);
    const isCeilLayer = (cover === "BKN" || cover === "OVC" || cover === "VV");
    if (isCeilLayer && isFinite(base)) {
      if (ceil === null || base < ceil) ceil = base;
    }
  }
  return ceil;
}

async function fetchMetar(station) {
  const url = `${RENDER_BASE}/metar?ids=${encodeURIComponent(station)}`;
  const res = await fetch(url, { cache: "no-store" });
  if (!res.ok) throw new Error(`METAR fetch failed: ${res.status}`);
  const arr = await res.json();
  return arr?.[0] || null;
}

function fmtTempC(v) {
  if (v == null || !isFinite(Number(v))) return null;
  return `${Number(v).toFixed(1)}°C`;
}

function fmtAltimInHg(v) {
  if (v == null || !isFinite(Number(v))) return null;
  return `${Number(v).toFixed(2)} inHg`;
}

function fmtVisSm(v) {
  if (v == null || !isFinite(Number(v))) return null;
  // Keep as-is; METAR often uses 10 for 10SM etc.
  return `${Number(v)} mi`;
}

function setText(id, text) {
  const el = document.getElementById(id);
  if (el) el.textContent = text;
}

async function updateAwosLine() {
  const stationTitle = document.getElementById("stationTitle");
  stationTitle.textContent = `${STATION} AWOS`;

  const metar = await fetchMetar(STATION);
  if (!metar) throw new Error("No METAR data returned");

  // Prefer rawOb if present (aviationweather frequently uses rawOb)
  const raw = (metar.rawOb || metar.raw_text || "").toString();
  setText("rawMetar", raw ? `RAW: ${raw}` : "");

  // Wind
  let wind = "Wind: N/A";
  if (metar.wdir != null && metar.wspd != null) {
    wind = `Wind: ${metar.wdir}° @ ${metar.wspd} kt` + (metar.wgst ? ` (G${metar.wgst})` : "");
  }

  // Temp/Dew
  const temp = fmtTempC(metar.temp);
  const dew = fmtTempC(metar.dewp);

  // Altimeter / Visibility (do not show N/A; just omit if missing)
  const altim = fmtAltimInHg(metar.altim);
  const vis = fmtVisSm(metar.visib);

  // Ceiling + Flight category
  const ceilingFt = extractCeilingFt(metar);
  const visNum = (metar.visib != null && isFinite(Number(metar.visib))) ? Number(metar.visib) : null;
  const fltCatApi = (metar.fltcat || metar.fltCat || "").toString().toUpperCase();
  const fltCat = fltCatApi || calcFlightCategory(visNum, ceilingFt);

  const parts = [];
  parts.push(wind);
  parts.push(`Temp: ${temp ?? "N/A"}`);
  parts.push(`Dewpoint: ${dew ?? "N/A"}`);
  if (altim) parts.push(`Altimeter: ${altim}`);
  if (vis) parts.push(`Visibility: ${vis}`);
  parts.push(`Flight Cat: ${fltCat}`);

  setText("awosLine", parts.join(" | "));
}

async function refresh() {
  try {
    await updateAwosLine();
  } catch (e) {
    console.error(e);
    setText("awosLine", "AWOS unavailable (check proxy / station).");
  }
}

refresh();
setInterval(refresh, 60000);
</script>
</body>
</html>
